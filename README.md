# Golang eth contract example

[![Go Report Card](https://goreportcard.com/badge/lillilli/geth_contract)](https://goreportcard.com/report/lillilli/geth_contract)

## Задача

Задача - отслеживать транзакции отправленные фронтэндом.

Фронтэнд оправляет бизнес-данные на бекэнд. Бекэнд отправляет транзакцию, содержащую эти данные, на смарт-контракт в сети Ethereum. Фронтэнд не обладает доступом в блокчейн и у него нет возможности проверить статус исполненности транзакции. Выполнение транзакции может занимать несколько минут, UI всё это время не может держать сессию. Предложить решение, при котором несколько инстансов фронтэнда одновременно может отправлять транзакции и отслеживать их статусы.

- Смарт контракт можно написать самому, логика его работы совершенно не важна. 
- Для тестирования можно использовать тестовую сеть Ethereum Kovan.
- Работу фронтона можно моделировать curl'ом.

## Решение, мысли

### 1. Обновление статусов на фронте

Т.к. в условии задачи сказано, что UI не может держать сессию все время, а для работы фронта можно использовать курл, то логично, что в качестве протокола общения клиента - сервера порузамевается не ws. Поэтому я решил, что для обновления статусов будет использоваться pooling.

### 2. Отслеживание статусов транзакий клиентами

По хорошему клиентам должен присваиваться uid (например при регистрации) и они с этим uid будут делать запросы. Т.к. это тестовое я решил, что клиенты будут делать запросы с ключом сессии, который сами выберут и  по этому ключу пользователям будут возвращаться транзакции и их статусы.

### 3. Хранение пользовательских данных

По хорошему нужно сохранять пользовательские данные в какой-нибудь storage, но т.к. это тестовое я решил, что данные будут сохраняться в оперативную память (соответственно протухать при завершении работы сервиса).

### 4. Отслеживание статусов транзакий сервером

По хорошему статусы транзакции нужно подтягивать из блоков, но для простоты я решил, что статуты будут браться напрямую при изменении высоты блока по сравнению с сохраненной высотой.


## Проблемные места

 - go mod vaendor при скачивании пакета github.com/ethereum/go-ethereum не скачивает C файлы, которые инклудятся внутри go файлов, поэтому приходится выкачивать пакет go get-м и копировать недостающие файлы руками


## Contract

В качестве контракта я решил использовать Counter, реализующий 3 метода:

1. getCount() - возвращает текущее состояние контракта
2. incrementCounter() - увеличивает состояние системы на 1
2. decrementCounter() - уменьшает состояние системы на 1 


## API

### Получение текущего состояния

```http
GET /state/latest
```

Response:

```http
200 {"value":"-3"}
```

### Инкермент

```http
GET /state/increment?session=asd
```

Response:

```http
200 {"hash":"0x580c807932bbcb6cb80903046a3b6a43935aa789b087062118f7525dbc3e14c6","pending":true}
```

### Декремент

```http
GET /state/decrement?session=asd
```

Response:

```http
200 {"hash":"0x580c807932bbcb6cb80903046a3b6a43935aa789b087062118f7525dbc3e14c6","pending":true}
```

### Состояние транзакций пользователя

```http
GET /tx/session?session=asd
```

Response:

```http
200 [
  {"hash":"0x580c807932bbcb6cb80903046a3b6a43935aa789b087062118f7525dbc3e14c6","pending":false},{"hash":"0xf3f4ed425e4d762358f47a33a3951e716836c9b3dac81fa0922901c99f238835","pending":true}
]
```

## Запуск

### Удаленный сервер

Можно делать запросы на удаленный сервер для тестирования:
http://68.183.40.252:3000

### Локальный запуск

#### Requirements

- You need to have vgo installed.
- You need to have npm, solc installed.

### Docker

1. Clone the repository.
2. Create the config file.
3. Make image (need some time).
4. Launch image (will be available on localhost:8080).

```bash
git clone https://github.com/lillilli/geth_contract.git && cd geth_contract
make config && make run:image
```

### Local launch

1. Clone the repository.
2. Install dependencies, create the config file.
3. Generate contract go file.
4. Launch the project.

```bash
git clone https://github.com/lillilli/geth_contract.git && cd geth_contract
make setup && make config
make gen_contract
make run
```

### Client local launch

#### Алгоритм работы

Клиент запрашивает текущее value системы,
затем делает от 1 до 3 запросов (рандом) на инкемент / декремент (рандом), после чего начинает опрашивать их состояние с интервалом в 5 секунд.
После того, как все транзакции попали в блоки (для простоты статуса всего 2 pending = true / false) скрипт заканчивает свою работу.

#### Launch

Поменять SERVER_URL, если нужно.

```bash
cd tools/client && npm i && node index.js
```

### Commands

To see all commands exec

```bash
make help
```